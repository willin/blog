---
title: Next.js 13 appDir å®æˆ˜ i18n
date: '2022-12-03'
description: Next.js 13 + appDir å®éªŒç‰¹æ€§ + i18n æœåŠ¡å™¨/å®¢æˆ·ç«¯ç»„ä»¶æ¸²æŸ“
category: æŠ€æœ¯
tags: [nextjs, å…¨æ ˆ, react, åšå®¢, i18n]
image: /images/blog/bg.jpg
---

# èƒŒæ™¯

å®˜æ–¹ç›®å‰æœªæ‰“ç®—æ”¯æŒ i18n å›½é™…åŒ–è·¯ç”±æ”¯æŒï¼Œä¸”å°šæœªæä¾›è§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡å®éªŒç‰¹æ€§ appDir æ¥å®ç°ã€‚

> ## Not Planned Features
>
> We are currently not planning to include the following features in app:
>
> - Internationalization (i18n) - we will be providing a guide on how to implement internationalization in app.
> - AMP Support
>
> If you need any of these features, we will continue to support `pages`, including bug fixes and feature additions, for multiple major versions.

æ–‡æ¡£åœ°å€ï¼š https://beta.nextjs.org/docs/app-directory-roadmap#not-planned-features

é¦–å…ˆéœ€è¦äº†è§£ä¸€ä¸‹ `Server and Client Components` æœåŠ¡å™¨ç»„ä»¶å’Œå®¢æˆ·ç«¯ç»„ä»¶ã€‚

| What do you need to do?                                                                                        | Server Component | Client Component                                                                        |
| :------------------------------------------------------------------------------------------------------------- | :--------------- | :-------------------------------------------------------------------------------------- |
| Fetch data. [Learn more](https://beta.nextjs.org/docs/data-fetching/fetching).                                 | âœ…               | [âš ï¸](https://beta.nextjs.org/docs/rendering/server-and-client-components#data-fetching) |
| Access backend resources (directly)                                                                            | âœ…               | âŒ                                                                                      |
| Keep sensitive information on the server (access tokens, API keys, etc)                                        | âœ…               | âŒ                                                                                      |
| Keep large dependencies on the server / Reduce client-side JavaScript                                          | âœ…               | âŒ                                                                                      |
| Add interactivity and event listeners (`onClick()`, `onChange()`, etc)                                         | âŒ               | âœ…                                                                                      |
| Use State and Lifecycle Effects (`useState()`, `useReducer()`, `useEffect()`, etc)                             | âŒ               | âœ…                                                                                      |
| Use browser-only APIs                                                                                          | âŒ               | âœ…                                                                                      |
| Use custom hooks that depend on state, effects, or browser-only APIs                                           | âŒ               | âœ…                                                                                      |
| Use [React Class components](https://reactjs.org/docs/components-and-props.html#function-and-class-components) | âŒ               | âœ…                                                                                      |

ç®€å•æ¥è¯´ï¼ŒæœåŠ¡å™¨ç«¯ç»„ä»¶ä¸æ”¯æŒäº‹ä»¶ä¾¦å¬ã€ä¸æ”¯æŒç”Ÿå‘½å‘¨æœŸçŠ¶æ€ï¼Œè¿™å¯¼è‡´äº†åŸæœ‰çš„å¥½å¤šç»„ä»¶ä¸å¯ä»¥ç›´æ¥æ‹¿æ¥å°±ç”¨äº†ã€‚æ¯”å¦‚ next-i18nextï¼Œ next-themes ç­‰ç­‰å¥½å¤šï¼Œç›´æ¥å¼•å…¥ä½¿ç”¨ä¼šæŠ¥å„ç§è«åå…¶å¦™çš„é”™è¯¯ã€‚

åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥è¿›å…¥æ­£é¢˜ã€‚

# å®ç°

## i18n æ–¹æ³•

é¦–å…ˆä½ éœ€è¦ä¸€ä¸ª i18n çš„å®ç°ï¼Œå¯ä»¥ç”¨ i18nextï¼Œä¹Ÿå¯ä»¥ç”¨ rosetta ä¹‹ç±»çš„ã€‚æˆ‘è¿™é‡Œå®ç°äº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ã€‚

```ts
// å‚è€ƒç¤ºä¾‹é¡¹ç›®çš„ /i18n/next-i18n.ts
import dlv from 'dlv';
import tmpl from 'templite';

// eslint-disable-next-line no-unused-vars
type Fn = (...args: any[]) => string;
export interface I18nDict {
  [key: string]: string | number | Fn | I18nDict;
}

export interface NextI18nOptions {
  /**
   * Define the list of supported languages, this is used to determine if one of
   * the languages requested by the user is supported by the application.
   * This should be be same as the supportedLngs in the i18next options.
   */
  supportedLanguages: string[];
  /**
   * Define the fallback language that it's going to be used in the case user
   * expected language is not supported.
   * This should be be same as the fallbackLng in the i18next options.
   */
  fallbackLng: string;
}

export class NextI18n {
  private currentLocale: string;

  public fallbackLng: string;

  public supportedLanguages: string[];

  private dict: I18nDict = {};

  constructor(options: NextI18nOptions) {
    this.currentLocale = options.fallbackLng;
    this.supportedLanguages = options.supportedLanguages;
    this.fallbackLng = options.fallbackLng;
  }

  public locale = (lang?: string) => {
    if (lang !== undefined && this.currentLocale !== lang) {
      this.currentLocale = lang;
      this.onChangeLanguage?.(lang);
    }
    return this.currentLocale;
  };

  public set = (lang: string, dict: I18nDict) => {
    this.dict[lang] = Object.assign(this.dict[lang] || {}, dict);
  };

  public t = (key: string, params?: any, lang?: string): string => {
    // eslint-disable-next-line
    const val = dlv(this.dict[lang || this.currentLocale] as any, key, key);
    // eslint-disable-next-line
    if (typeof val === 'function') return val(params) as string;
    // eslint-disable-next-line
    if (typeof val === 'string') return tmpl(val, params);
    return val as string;
  };

  /* PROTECTED */
  // eslint-disable-next-line no-unused-vars
  private onChangeLanguage?: (locale: string) => void;

  // eslint-disable-next-line no-unused-vars
  public setOnChange = (fn: (locale: string) => void) => {
    this.onChangeLanguage = fn;
  };
}
```

ç„¶åæ˜¯åˆå§‹åŒ–è¿™ä¸ª i18n å®ä¾‹ï¼š

```ts
// å‚è€ƒç¤ºä¾‹é¡¹ç›®çš„ /i18n/index.ts
import { NextI18n } from './next-i18n';

export const languages = {
  'zh-CN': { name: 'ç®€ä½“ä¸­æ–‡', flag: 'ğŸ‡¨ğŸ‡³', unicode: '1f1e8-1f1f3' },
  'zh-TW': { name: 'æ­£é«”ä¸­æ–‡', flag: 'ğŸ‡¹ğŸ‡¼', unicode: '1f1f9-1f1fc' },
  en: { name: 'English', flag: 'ğŸ‡ºğŸ‡¸', unicode: '1f1fa-1f1f8' },
  ko: { name: 'í•œêµ­ì–´', flag: 'ğŸ‡°ğŸ‡·', unicode: '1f1f0-1f1f7' },
  ja: { name: 'æ—¥æœ¬èª', flag: 'ğŸ‡¯ğŸ‡µ', unicode: '1f1ef-1f1f5' }
};

export const supportedLanguages = Object.keys(languages);
export const fallbackLng = 'zh-CN';

const i18n = new NextI18n({
  supportedLanguages,
  fallbackLng
});

supportedLanguages.forEach((locale) => {
  // eslint-disable-next-line @typescript-eslint/no-unsafe-argument
  i18n.set(locale, require(`./${locale}/common.json`));
});

export default i18n;
```

## Provider

æ³¨æ„ Provider ä¸­ç”¨åˆ°äº† `useState` æ¥å¼ºåˆ¶åˆ·æ–°ï¼Œæ‰€ä»¥å¿…é¡»æ˜¯ä¸ª `Client Component`ã€‚

```ts
// å‚è€ƒç¤ºä¾‹é¡¹ç›®çš„ /i18n/provider.ts
'use client';

import { createContext, createElement, ReactNode, useMemo, useState } from 'react';
import { NextI18n } from './next-i18n';

export const context = createContext<{ i18n: NextI18n } | null>(null);

interface I18nProviderProps {
  children: ReactNode;
  i18n: NextI18n;
}

export function I18nProvider({ i18n, children }: I18nProviderProps) {
  const [, setTick] = useState(0);

  const value = useMemo(() => {
    // eslint-disable-next-line
    i18n.setOnChange(() => {
      setTick((s) => s + 1);
    });
    return { i18n };
  }, [i18n]);

  // eslint-disable-next-line react/no-children-prop
  return createElement(context.Provider, {
    value: { ...value },
    children
  });
}
```

## Hook

ä¸ç”¨è¯´ï¼Œä¹Ÿæ˜¯ä¸ª `Client Component`ã€‚

```ts
// å‚è€ƒç¤ºä¾‹é¡¹ç›®çš„ /i18n/hook.ts
'use client';

import { useContext } from 'react';
import { context } from './provider';

export function useI18n() {
  const content = useContext(context);
  if (!content) {
    throw new Error('Unable to get instance of i18n');
  }
  return content.i18n;
}
```

## app ä¸­åˆ›å»º

ä¸è¦ç›´æ¥åœ¨ layoutã€page ä¸­ä½¿ç”¨ `Client Component`ï¼Œæ‰€ä»¥æˆ‘åˆåœ¨ Provider ä¸Šå¥—äº†ä¸€å±‚ã€‚

```tsx
// laoyout.tsx
// æ‰‹åŠ¨å¥—ä¸€å±‚ provider
import { I18nClientProvider } from './providers';

export default function RootLayout({ children, params }: { children: React.ReactNode; params: { locale: string } }) {
  const { locale = 'zh-CN' } = params || {};

  return (
    <I18nClientProvider locale={locale}>
      <html lang={locale}>
        <head />
        <body>
          <div className='pt-20' style={{ minHeight: 'calc(100vh - 75px)' }}>
            {children}
          </div>
        </body>
      </html>
    </I18nClientProvider>
  );
}
```

è¿™ä¸ª Provider çš„ä»£ç ä¸ºï¼š

```tsx
'use client';
import { I18nProvider, i18n } from '@/i18n';
import { useEffect } from 'react';

export function I18nClientProvider({ children, locale }: { children: React.ReactNode; locale: string }) {
  useEffect(() => {
    if (i18n.locale() !== locale) {
      i18n.locale(locale);
    }
  }, [locale]);

  return <I18nProvider i18n={i18n}>{children}</I18nProvider>;
}
```

# æœ€å

- é™„ä¸Šç¤ºä¾‹é¡¹ç›®ä»£ç ï¼š https://github.com/willin/beta.willin.wang/tree/87dce6e673659dbc8e5a3aac25e3cb6f6ea828bb
- ç¤ºä¾‹é¡¹ç›®æ¼”ç¤ºåœ°å€ï¼š https://willin-wang-ndd35eg64-willin.vercel.app/
