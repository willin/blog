---
title: Next.js ï¼ˆReactï¼‰ å®ç”¨è¿›é˜¶æŠ€å·§
date: '2023-06-02'
description: è‡ªç”¨æ•´ç†çš„ Next.js æˆ– React é¡¹ç›®è¿›é˜¶å°æŠ€å·§ã€‚
category: æŠ€æœ¯
tags: [next.js, å…¨æ ˆ, react, åšå®¢]
---

è€ç‹é€€ä¼‘å•¦ï¼Œä»Šå¤©æ˜¯é€€ä¼‘çš„ç¬¬äºŒå¤©ï¼Œå·²ç»å›åˆ°äº†è€å®¶ä¹¡ä¸‹ï¼Œæ—©ä¸Šåœ¨ç”°é‡Œçœ‹åˆ°äº†å°éº¦~

ç¬¬ä¸€ç¯‡æ–‡ç« å›´ç»•ç€æœ€è¿‘ç»å¸¸ä½¿ç”¨çš„ Next.js ç›¸å…³å±•å¼€ã€‚ç”±äº Next.js ä½¿ç”¨çš„æ˜¯ React æ¡†æ¶ï¼Œæ‰€ä»¥éƒ¨åˆ†å†…å®¹å¯èƒ½ä»…ä¸ React ç›¸å…³ã€‚

## æ–‡ç« ç›®å½•

- å¹¿å‘Šå’Œæ£€æŸ¥å¹¿å‘Šæ‹¦æˆªå™¨ï¼ˆAdblockï¼‰ç›¸å…³
- ä¸»é¢˜åˆ‡æ¢ç›¸å…³
- ç¯å¢ƒå˜é‡ç›¸å…³
- åœ¨ Vercel ä¸Šä½¿ç”¨ Cloudflare KV

## Anti Adblock

æ£€æŸ¥æµè§ˆå™¨å¹¿å‘Šæ‹¦æˆªæ’ä»¶å¹¶é˜»æ­¢ã€‚è¿™æ®µä»£ç ä½¿ç”¨äºæˆ‘çš„å…è´¹åŸŸåç®¡ç†ç³»ç»Ÿï¼Œå¼ºåˆ¶ç”¨æˆ·å…³é—­å¹¿å‘Šæ‹¦æˆªæ’ä»¶æ‰èƒ½ç»§ç»­ä½¿ç”¨ã€‚ï¼ˆå¯¹ä¸ä½äº†ï¼Œè™½ç„¶æ˜¯ä¸€ä¸ªå¼€æºå…¬ç›Šæ€§è´¨çš„é¡¹ç›®ï¼Œä½†ç”±äºé€€ä¼‘åå·²ç»æ²¡æœ‰æ”¶å…¥æ¥æºï¼Œå¹¿å‘Šæ”¶ç›ŠèšŠå­è‚‰ä¹Ÿä¸å®¹å°è§‘ã€‚ï¼‰

> å…è´¹æ³¨å†ŒåŸŸåï¼š [https://domain.willin.wang](https://domain.willin.wang)
>
> ç›®å‰æ”¯æŒçš„åç¼€æœ‰ï¼š `js.cool`, `log.lu`, `kaiyuan.fund`, `sh.gg`, `v0.chat`, `æ†¨æ†¨.æˆ‘çˆ±ä½ `

å…¶æºç ä½äºï¼š https://github.com/willin/domain/blob/main/app/%5Blang%5D/bootstrap.tsx

```tsx title="bootstrap.tsx" showLineNumbers {18-19,33}
'use client';
import Script from 'next/script';
import { useEffect } from 'react';
import { usePathname } from 'next/navigation';

const SCRIPT = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-xxxxxx';

export function Bootstrap() {
  const pathname = usePathname();
  useEffect(() => {
    try {
      // @ts-ignore
      // eslint-disable-next-line
      (window.adsbygoogle = window.adsbygoogle || []).push({});
    } catch (e) {
      //
    }
    // Ignore core pages
    if (pathname === '/zh' || pathname === '/en') return;
    // (A) TEST FETCH HEADER REQUEST TO GOOGLE ADSENSE
    const test = new Request(
      SCRIPT,
      // "https://static.ads-twitter.com/uwt.js",
      { method: 'HEAD', mode: 'no-cors' }
    );

    // (B) FIRE THE REQEST
    let result: boolean;
    fetch(test)
      .then(() => (result = true))
      .catch(() => (result = false))
      .finally(() => {
        const elm = document.querySelector('ins.adsbygoogle');
        if (
          !result ||
          // @ts-ignore
          (elm && window.getComputedStyle(elm).display === 'none') ||
          // @ts-ignore
          (elm && window.getComputedStyle(elm.parentElement).display === 'none')
        ) {
          // åˆ é™¤æ–‡ç« æ­£æ–‡
          const sponsor = document.querySelector('article.prose');
          if (!sponsor) return;
          const prompt = document.createElement('div');
          // @ts-ignore
          prompt.style =
            'border: 1px solid #c6c6c6;border-radius: 4px;background-color: #f5f2f0;padding: 15px; margin:10px 0; font-size: 1.25rem;';
          prompt.innerHTML =
            '<p>æ‚¨ä½¿ç”¨äº†å¹¿å‘Šæ‹¦æˆªå™¨ï¼Œå¯¼è‡´æœ¬ç«™å†…å®¹æ— æ³•æ˜¾ç¤ºã€‚</p><p>è¯·å°† willin.wang åŠ å…¥ç™½åå•ï¼Œè§£é™¤å¹¿å‘Šå±è”½åï¼Œåˆ·æ–°é¡µé¢ã€‚è°¢è°¢ã€‚</p>';
          prompt.innerHTML +=
            '<hr style="margin: 5px 0" /><p>Adblock Detected</p><p>Please set willin.wang to the unblocked list, and refresh the page, thanks.</p>';
          // @ts-ignore
          sponsor.parentNode.replaceChild(prompt, sponsor);
        }
      });
  }, [pathname]);

  return (
    <>
      <Script async={true} src={SCRIPT} crossOrigin='anonymous' />
    </>
  );
}
```

### æ’é™¤éœ€è¦æ£€æŸ¥çš„è·¯ç”±

åœ¨ Line 18-19 è¡Œå¤„ã€‚

```ts
if (pathname === '/zh' || pathname === '/en') return;
```

å¯ä»¥æ‰‹å†™ï¼Œå¯ä»¥ä»é…ç½®è¯»å–ï¼Œè¿˜å¯ä»¥ç”¨æ•°ç»„æ–¹å¼ã€‚çœ‹è‡ªå·±å–œå¥½äº†ã€‚å¦‚æœä¸éœ€è¦æ’é™¤éƒ¨åˆ†ç‰¹æ®Šçš„è·¯ç”±ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åˆ æ‰ã€‚

### è®¾ç½®éœ€è¦æ£€æµ‹çš„å…³é”®å¹¿å‘Šå…ƒç´ 

```ts
const elm = document.querySelector('ins.adsbygoogle');
```

æ¯”å¦‚æˆ‘çš„å¹¿å‘Šæ˜¯è°·æ­Œ Adsenseï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶ä»–çš„ï¼Œæ¯”å¦‚ Twitter çš„å¹¿å‘Šã€è‡ªå®šä¹‰çš„å¹¿å‘Šæ¨¡å—ï¼Œåªéœ€æ›¿æ¢å…¶ä¸­çš„é€‰æ‹©å™¨ï¼Œè·å–ç¬¬ä¸€ä¸ªå¹¿å‘Šå…ƒç´ å³å¯ï¼š

```ts
// ç¤ºä¾‹ï¼š
const elm = document.querySelector('.ads');
// or
const elm = document.querySelector('#ads');
```

### è¿›é˜¶ 1ï¼šç‰¹æ®Šä¼šå‘˜æƒé™å…å¹¿å‘Š

è¿™ä¸ªç›®å‰åœ¨æˆ‘çš„åšå®¢ç³»ç»Ÿä¸­ç”¨åˆ°äº†ï¼š [https://willin.wang](https://willin.wang)

å…¶æºç ä½äºï¼š https://github.com/willin/blog/blob/main/app/%5Blang%5D/bootstrap.tsx

åœ¨æœ€åˆçš„ä»£ç ä¸Šç¨åŠ å®Œå–„ï¼š

```tsx title="bootstrap.tsx" showLineNumbers {11,15,63}
'use client';
import Script from 'next/script';
import { useEffect } from 'react';
import { usePathname } from 'next/navigation';
import { useLoginInfo } from './use-login';

const SCRIPT = 'https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-xxxxxx';

export function Bootstrap() {
  // å¼•å…¥ç”¨æˆ·ä¿¡æ¯
  const { loading, following, vip } = useLoginInfo();
  const pathname = usePathname();
  useEffect(() => {
    // å¦‚æœæ˜¯ç‰¹æ®Šç±»å‹ä¼šå‘˜ï¼Œç›´æ¥è·³è¿‡
    if (loading || following || vip) return;
    try {
      // @ts-ignore
      // eslint-disable-next-line
      (window.adsbygoogle = window.adsbygoogle || []).push({});
    } catch (e) {
      //
    }
    // Ignore core pages
    if (pathname.includes('/sponsor') || pathname.includes('/about') || pathname.includes('/projects')) return;
    // (A) TEST FETCH HEADER REQUEST TO GOOGLE ADSENSE
    const test = new Request(
      SCRIPT,
      // "https://static.ads-twitter.com/uwt.js",
      { method: 'HEAD', mode: 'no-cors' }
    );

    // (B) FIRE THE REQEST
    let result: boolean;
    fetch(test)
      .then(() => (result = true))
      .catch(() => (result = false))
      .finally(() => {
        const elm = document.querySelector('ins.adsbygoogle');
        if (
          !result ||
          // @ts-ignore
          (elm && window.getComputedStyle(elm).display === 'none') ||
          // @ts-ignore
          (elm && window.getComputedStyle(elm.parentElement).display === 'none')
        ) {
          // åˆ é™¤æ–‡ç« æ­£æ–‡
          const sponsor = document.querySelector('article.prose');
          if (!sponsor) return;
          const prompt = document.createElement('div');
          // @ts-ignore
          prompt.style =
            'border: 1px solid #c6c6c6;border-radius: 4px;background-color: #f5f2f0;padding: 15px; margin:10px 0; font-size: 2rem;';
          prompt.innerHTML =
            '<p>æ‚¨ä½¿ç”¨äº†å¹¿å‘Šæ‹¦æˆªå™¨ï¼Œå¯¼è‡´æœ¬ç«™å†…å®¹æ— æ³•æ˜¾ç¤ºã€‚</p><p>è¯·å°† willin.wang åŠ å…¥ç™½åå•ï¼Œè§£é™¤å¹¿å‘Šå±è”½åï¼Œåˆ·æ–°é¡µé¢ã€‚è°¢è°¢ã€‚</p>';
          prompt.innerHTML +=
            '<hr style="margin: 5px 0" /><p>Adblock Detected</p><p>Please set willin.wang to the unblocked list, and refresh the page, thanks.</p>';
          // @ts-ignore
          sponsor.parentNode.replaceChild(prompt, sponsor);
        }
      });
  }, [pathname, following, loading, vip]);
  // å¦‚æœæ˜¯ç‰¹æ®Šç±»å‹ä¼šå‘˜ï¼Œä¸åŠ è½½å¹¿å‘Šç»„ä»¶
  if (loading || following || vip) return null;

  return (
    <>
      <Script async={true} src={SCRIPT} crossOrigin='anonymous' />
    </>
  );
}
```

æ³¨æ„å…¶ä¸­çš„ä¸‰è¡Œå…³é”®ä»£ç å³å¯ï¼š

- Line `11`ï¼š å¼•å…¥ä¼šå‘˜çŠ¶æ€
- Line `15`ï¼š å¦‚æœæ˜¯ç‰¹æ®Šä¼šå‘˜è·³è¿‡æ£€æŸ¥
- Line `63`ï¼š å¦‚æœæ˜¯ç‰¹æ®Šä¼šå‘˜å…å¹¿å‘Šç»„ä»¶/è„šæœ¬åŠ è½½

### è¿›é˜¶ 2ï¼šç”Ÿæˆé’©å­

è¿™éƒ¨åˆ†ä»£ç æ˜¯æˆ‘ä»ç½‘ä¸Šæœç´¢å„ç§æ¡ˆä¾‹æ€»ç»“å‡ºæ¥çš„ç®—æ˜¯è¾ƒä¸ºå…¨é¢çš„ä¸€ç§æ–¹å¼äº†ï¼Œç”±äºåŸºæœ¬éƒ½æ˜¯åŸç”Ÿ js å®ç°ï¼Œæ‰€ä»¥çœ‹èµ·æ¥å¹¶ä¸ç¾è§‚ã€‚

è¿˜å¯ä»¥ä¼˜é›…ä¸€äº›å»è¿›è¡Œå…¨å±€çš„åˆ¤æ–­ï¼Œè¿™é‡Œç»™å‡ºä¸€ä¸ªç¤ºä¾‹ï¼ˆæœªç»è¿‡å®é™…æµ‹è¯•ï¼‰ï¼š

```ts title="useAntiAdblock.ts"
export function useAntiAdblock() {
  // è®¾ç½®ä¸€ä¸ªé»˜è®¤å€¼ï¼Œ false æœªé»˜è®¤ä¼˜å…ˆæ˜¾ç¤ºå¹¿å‘Šæ‹¦æˆªæç¤ºï¼Œ true ä¸ºé»˜è®¤ä¼˜å…ˆæ˜¾ç¤ºä¸»è¦å†…å®¹
  const [adsCanshow, setAdsCanshow] = useState(false);
  const pathname = usePathname();
  useEffect(() => {
    try {
      // @ts-ignore
      // eslint-disable-next-line
      (window.adsbygoogle = window.adsbygoogle || []).push({});
    } catch (e) {
      //
    }
    // Ignore core pages
    if (pathname === '/zh' || pathname === '/en') {
      setAdsCanshow(true);
      return;
    }
    // (A) TEST FETCH HEADER REQUEST TO GOOGLE ADSENSE
    const test = new Request(
      SCRIPT,
      // "https://static.ads-twitter.com/uwt.js",
      { method: 'HEAD', mode: 'no-cors' }
    );

    // (B) FIRE THE REQEST
    let result: boolean;
    fetch(test)
      .then(() => (result = true))
      .catch(() => (result = false))
      .finally(() => {
        const elm = document.querySelector('ins.adsbygoogle');
        if (
          !result ||
          // @ts-ignore
          (elm && window.getComputedStyle(elm).display === 'none') ||
          // @ts-ignore
          (elm && window.getComputedStyle(elm.parentElement).display === 'none')
        ) {
          setAdsCanshow(true);
        } else {
          setAdsCanshow(false);
        }
      });
  }, [pathname]);

  return adsCanshow;
}
```

ç„¶ååœ¨ç»„ä»¶ä¸­ä½¿ç”¨ï¼š

```tsx title="Component.tsx"
export function Component() {
  const adsCanShow = useAntiAdblock();
  if (!adsCanShow) {
    return <div>å¹¿å‘Šæ‹¦æˆªæç¤º</div>;
  }

  return <div>ç»„ä»¶ä¸»ä½“å†…å®¹</div>;
}
```

## ä¸»é¢˜åˆ‡æ¢

è™½ç„¶æœ‰ä¸€ä¸ª Next.js ä¸“å±çš„ä¸»é¢˜åˆ‡æ¢æ’ä»¶ `next-themes` äº†ï¼Œä½†æ˜¯ç”±äºé•¿ä¹…æ²¡æœ‰ç»´æŠ¤ï¼Œåœ¨ Next.js 13 ä¸‹é‡åˆ°äº†å„ç§å‘ï¼Œè™½ç„¶èƒ½è§£å†³ï¼Œä½†å¡«èµ·æ¥ååˆ†éº»çƒ¦ã€‚

åæ¥æˆ‘å‚è€ƒ `theme-change` æ’ä»¶ä½¿ç”¨ï¼Œç®€åŒ–äº†ä¸€ä¸‹ã€‚ä»£ç å‚è€ƒï¼š https://github.com/willin/domain/blob/main/app/%5Blang%5D/themes.tsx

```tsx title="themes.tsx" showLineNumbers {8,47,49-50}
'use client';
import { themeChange } from 'theme-change';
import { useEffect } from 'react';
import { themes } from '@/lib/themes';

export function ThemeChange({ title }: { [k: string]: string }) {
  useEffect(() => {
    themeChange(false);
    // ğŸ‘† false parameter is required for react project
  }, []);

  return (
    <div title={title} className='dropdown dropdown-end'>
      {/* <div>The current theme is: {currentTheme}</div> */}
      <div tabIndex={0} className='btn gap-1 normal-case btn-ghost'>
        <svg
          width='20'
          height='20'
          xmlns='http://www.w3.org/2000/svg'
          fill='none'
          viewBox='0 0 24 24'
          className='inline-block h-5 w-5 stroke-current md:h-6 md:w-6'>
          <path
            strokeLinecap='round'
            strokeLinejoin='round'
            strokeWidth={2}
            d='M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01'
          />
        </svg>
        {/* <span className='hidden md:inline'>{$t('change-theme-btn')}</span> */}
        <svg
          width='12px'
          height='12px'
          className='ml-1 hidden h-3 w-3 fill-current opacity-60 sm:inline-block'
          xmlns='http://www.w3.org/2000/svg'
          viewBox='0 0 2048 2048'>
          <path d='M1799 349l242 241-1017 1017L7 590l242-241 775 775 775-775z' />
        </svg>
      </div>
      <div
        tabIndex={0}
        className='dropdown-content bg-base-200 text-base-content rounded-t-box rounded-b-box top-px max-h-96 h-[70vh] w-52 overflow-y-auto shadow-2xl mt-16'>
        <div className='grid grid-cols-1 gap-3 p-3'>
          {themes.map((theme) => (
            // eslint-disable-next-line jsx-a11y/click-events-have-key-events, jsx-a11y/no-static-element-interactions
            <div
              key={theme.id}
              className='outline-base-content overflow-hidden rounded-lg outline-2 outline-offset-2 hover:outline'
              data-set-theme={theme.id}
              data-act-class='outline'>
              <div data-theme={theme.id} className='bg-base-100 text-base-content w-full cursor-pointer font-sans'>
                <div className='grid grid-cols-5 grid-rows-3'>
                  <div className='col-span-5 row-span-3 row-start-1 flex gap-1 py-3 px-4'>
                    <div className='flex-grow text-sm font-bold'>{theme.id}</div>
                    <div className='flex flex-shrink-0 flex-wrap gap-1'>
                      <div className='bg-primary w-2 rounded' />
                      <div className='bg-secondary w-2 rounded' />
                      <div className='bg-accent w-2 rounded' />
                      <div className='bg-neutral w-2 rounded' />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}
```

æ³¨æ„å…¶ä¸­çš„ä¸¤å¤„å…³é”®ä»£ç å³å¯ï¼š

- Line `8`ï¼š React é¡¹ç›®çš„ç‰¹æ®Šå¤„ç†
- Line `47-50`ï¼š é…ç½®äº† `theme-change` çš„äº‹ä»¶

### è¿›é˜¶ä½¿ç”¨ï¼šæ•è·å½“å‰ä¸»é¢˜

å‚è€ƒä»£ç ï¼š https://github.com/willin/domain/blob/main/app/%5Blang%5D/background.tsx

```tsx title="background.tsx" showLineNumbers
'use client';
import { darkThemes } from '@/lib/themes';
import { useEffect } from 'react';

export function BackgroundImage() {
  useEffect(() => {
    const observer = new MutationObserver(() => {
      const theme = document.documentElement.getAttribute('data-theme') || '';
      const isDark = darkThemes.includes(theme);
      const elm = document.getElementById('background');
      if (isDark) {
        elm?.classList.add('dark');
      } else {
        elm?.classList.remove('dark');
      }
    });
    observer.observe(document.documentElement, { attributes: true });
    return () => {
      observer.disconnect();
    };
  }, []);

  return <div id='background'></div>;
}
```

è¿™é‡Œç”¨åˆ°äº† `MutationObserver` çš„ APIï¼Œæ¥ç›‘å¬é¡µé¢ä¸Šçš„ `data-theme` å±æ€§ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥å‚è€ƒä¹‹å‰ AntiAdblock ç« èŠ‚ï¼Œå¯¼å‡ºä¸€ä¸ª `useTheme` çš„é’©å­ï¼Œæ¥è·å–å½“å‰çš„ä¸»é¢˜ã€‚

## ç¯å¢ƒå˜é‡æ³¨æ„ç‚¹

ä¹ æƒ¯æ€§çš„ï¼Œæˆ‘ä»¬ä¼šåˆ›å»ºä¸€ä¸ªç±»ä¼¼çš„é…ç½®æ–‡ä»¶ï¼š

```ts title="config.ts"
export const AdminId = process.env.ADMIN_ID || 'default';
```

å…¶ä¸­ï¼Œä¼šç”¨åˆ° `process.env.XXX` è¿™æ ·çš„ç¯å¢ƒå˜é‡ã€‚ä½†åœ¨ç»„ä»¶ä¸­ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šæœ‰ä¸€äº›æ„æƒ³ä¸åˆ°çš„æƒ…å†µå‘ç”Ÿã€‚

```tsx title="component.tsx"
export function Component() {
  // çœç•¥ä¸€äº›ä»£ç 
  const user = useUser();
  return (
    <div>
      <div>ä¸€äº›å†…å®¹</div>
      {AdminId === user.id && <ComponentB />}
    </div>
  );
}
```

è¿™é‡Œçš„ `AdminId` ä¼šè¢«ç¼–è¯‘æˆ `default`ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æœŸæœ›çš„ `process.env.ADMIN_ID`ï¼Œè¿™æ˜¯å› ä¸º `AdminId` æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œç¼–è¯‘æ—¶å°±å·²ç»è¢«èµ‹å€¼äº†ã€‚æ‰€ä»¥åªèƒ½åœ¨ä»¥ä¸‹æƒ…å†µä¸‹ä½¿ç”¨ç³»ç»Ÿçš„ç¯å¢ƒå˜é‡ï¼š

- Server Actions ï¼ˆ`'use server;'` æ ‡è®°çš„æ–‡ä»¶ï¼‰
- API Routes ï¼ˆ`import 'server-only';`æ ‡è®°çš„æ–‡ä»¶ï¼‰
- ä¸€äº›å°è£…çš„æ–¹æ³•ï¼Œåªè¢«ä»¥ä¸Šä¸¤ç§æƒ…å†µè°ƒç”¨

## åœ¨ Vercel ä¸Šä½¿ç”¨ Cloudflare KV

ç›®å‰æˆ‘çš„å…è´¹åŸŸåç”³è¯·ç®¡ç†ç³»ç»Ÿæ˜¯ä½¿ç”¨çš„ Next.js éƒ¨ç½²åœ¨ Vercel ä¸Šï¼Œæœ€åˆä¹Ÿæ˜¯æ‰“ç®—éƒ¨ç½²åˆ° Cloudflare Pages ä¸Šçš„ï¼Œæ¯•ç«Ÿæœ‰å¯è§‚çš„å…è´¹ç”¨é‡ã€‚ä½†æ˜¯ Cloudflare Wrangler å¯¹äº Next.js çœŸå¿ƒä¸å¤ªå‹å¥½ï¼Œè€Œæœ€è¿‘çš„å‡ ä¸ªé¡¹ç›®éƒ½æ˜¯ç”¨ Next.jsï¼Œ æ‰€ä»¥å°±å·æ‡’æ²¡å»æŠ˜è…¾ Remix äº†ã€‚

å‚è€ƒåšå®¢æ–‡ç« ï¼š [remote-cloudflare-kv åœ¨ Vercel ä¸Šä½¿ç”¨ Cloudflare KV](https://willin.wang/zh/blog/remote-cloudflare-kv)
